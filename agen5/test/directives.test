#! /bin/sh
#  -*- Mode: Shell-script -*-
# directives.test --- test definition directives
#
# Time-stamp:        "2004-10-30 12:53:02 bkorb"
# Author:            Bruce Korb <bkorb@gnu.org>
# Maintainer:        Bruce Korb <bkorb@gnu.org>
# Created:           Fri Oct 1 10:27:31 PDT 1999
# Last Modified:     $Date: 2005/01/01 00:20:58 $
#            by: bkorb
#
# $Id: directives.test,v 4.1 2005/01/01 00:20:58 bkorb Exp $
# ----------------------------------------------------------------------

# Common definitions
if test -z "$srcdir"; then
    srcdir=`dirname $0`
    test "${VERBOSE+set}" != set && VERBOSE=1
fi
. $srcdir/defs

# # # # # # # # # # TEMPLATE FILE # # # # # # # # #

mkdir ${testname}.dir
mkdir ${testname}.dir/subdir
LDIR=`pwd`/${testname}.dir
export LDIR

echo creating ${testname}.dir/subdir/${testname}.tpl
cat > ${testname}.dir/subdir/${testname}.tpl <<'_EOF_'
[= AutoGen5 Template test =]
Irrelevant [=foo=].
_EOF_

# # # # # # # # # # DEFINITIONS FILE # # # # # # # # #

echo creating ${testname}.inc
cat > ${testname}.inc <<_EOF_
autogen definitions ${testname};

#option templ-dir \$LDIR/subdir

/*
#define COMMENT
#ifdef COMMENT
# error error in comment
 */

#ifdef MUMBLE
#  define MORE
#else
#  define FUMBLE
#endif
_EOF_

echo creating ${testname}.def
cat > ${testname}.def <<_EOF_
autogen definitions ${testname};

#include ${testname}.inc

#ifdef FUMBLE
#  error  we fumbled mumble
#endif

#ifndef MORE
#  error  we fumbled more
#endif

#if (FOO == 1)
#  error we got iffed
#elif (FOO == 0)
#  error we got FOO zeroed
#else
#  error we got lost
#endif

#shell

echo "#line 1 shelltext"
echo "foo = bar;"

#endshell

#define FUMBLE
#undef  MORE

#ifndef FUMBLE
#  error  we goofed fumble
#endif

#ifdef MORE
#  error  we mumbled more
#endif
_EOF_

# # # # # # # # # # EXPECTED OUTPUT FILE # # # # # # #

echo creating ${testname}.base
# this is the output we should expect to see
cat > ${testname}.base <<_EOF_
Irrelevant bar.
_EOF_

AGCMD="${AGexe} -DMUMBLE -DFOO=1"
echo ${AGCMD} ${testname}.def
${AGCMD} ${testname}.def || failure ${AGCMD} failed
cmp -s ${testname}.base ${testname}.test || \
  failure "`diff ${testname}.base ${testname}.test`"

cleanup
# end of directives.test
