#! /bin/sh
#  -*- Mode: Shell-script -*-
# ----------------------------------------------------------------------
# opts.test --- Verify the handling of options
#
# Time-stamp:       "2004-10-30 13:17:49 bkorb"
# Author:	        Bruce Korb <bkorb@gnu.org>
# Maintainer:	    Bruce Korb <bkorb@gnu.org>
# Created:	        Sat Mar 28 14:21:31 1998
#
# $Id: opts.test,v 3.2 2004/10/30 20:43:56 bkorb Exp $
# ----------------------------------------------------------------------

# Common definitions
if test -z "${srcdir}"; then
    srcdir=`dirname $0`
    test "${VERBOSE+set}" != set && VERBOSE=1
fi
. ${srcdir}/defs

#  Fetch the options files
#
unstamp()
{
  sed '/DO NOT EDIT THIS FILE/,/and the template file/d' $1 > $2 ||
    failure Cannot remove stamps from $1
}

workdir=`pwd`
rm -f ../VERSION ./opts.* || :

cd ${top_srcdir}/agen5
unstamp opts.c ${workdir}/opts.c.base
unstamp opts.h ${workdir}/opts.h.base
cp opts.def ${workdir}/.
cp -f ${top_srcdir}/VERSION ${workdir}/..

cd ${workdir}
set -x
ls -l * ../VERSION > $testname.log

echo Checking for "'define DEBUG'" options
if grep 'define DEBUG' ${srcdir}/../opts.h
then
  AGCMD="${AGexe} -L ${top_srcdir}/autoopts -DDEBUG=1"
else
  AGCMD="${AGexe} -L ${top_srcdir}/autoopts"
fi

echo ${AGCMD} opts.def
${AGCMD} opts.def || {
  rm -f ../VERSION
  failure ${AGCMD} opts.def
}

rm -f ../VERSION

unstamp opts.c opts.c.res
echo diff opts.c.base opts.c.res
diff opts.c.base opts.c.res || \
  failure "`diff -c opts.c.base opts.c.res`"

unstamp opts.h opts.h.res
echo diff opts.h.base opts.h.res
diff opts.h.base opts.h.res || \
  failure "`diff -c opts.h.base opts.h.res`"

cleanup
# opts.test ends here
