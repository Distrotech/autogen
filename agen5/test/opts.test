#! /bin/sh
#  -*- Mode: Shell-script -*-
# ----------------------------------------------------------------------
# opts.test --- Verify the handling of options
#
# Author:	     Bruce Korb <bkorb@gnu.org>
# Maintainer:	     Bruce Korb <bkorb@gnu.org>
# Created:	     Sat Mar 28 14:21:31 1998
# Last Modified:     $Date: 2000/08/09 14:56:25 $
#            by:     Bruce Korb <bkorb@gnu.org>
#
# $Id: opts.test,v 1.7 2000/08/09 14:56:25 bkorb Exp $
# ----------------------------------------------------------------------

# Common definitions
if test -z "$srcdir"; then
    srcdir=`echo "$0" | sed 's,[^/]*$,,'`
    test -z "$srcdir" && srcdir=.
    test "$srcdir" = "$0" && srcdir=.
    test "${VERBOSE+set}" != set && VERBOSE=1
fi
. $srcdir/defs

#  Fetch the options files
#
unstamp()
{
  sed '/DO NOT EDIT THIS FILE/,/and the template file/d' $1 > $2 ||
    failure Cannot remove stamps from $1
}

workdir=`pwd`
rm -f ../VERSION ./opts.* || :
agopts=`
  cd ..
  cd $srcdir/..

  unstamp opts.c $workdir/opts.c.base
  unstamp opts.h $workdir/opts.h.base

  cp opts.def $workdir/
  cp -f ../VERSION $workdir/..
  cd ../autoopts
  pwd` || exit 1

set -x
ls -l * ../VERSION > $testname.log

echo Checking for "'define DEBUG'" options
if grep 'define DEBUG' $srcdir/../opts.h
then
  AGEXE="$AGEXE -L $agopts -DDEBUG=1"
else
  AGEXE="$AGEXE -L $agopts"
fi

echo $AGEXE opts.def
$AGEXE opts.def || {
  rm -f ../VERSION
  failure $AGEXE $agopts opts.def
}

rm -f ../VERSION

unstamp opts.c opts.c.res
echo diff opts.c.base opts.c.res
diff opts.c.base opts.c.res || \
  failure differ opts.c.base opts.c.res

unstamp opts.h opts.h.res
echo diff opts.h.base opts.h.res
diff opts.h.base opts.h.res || \
  failure differ opts.h.base opts.h.res

cleanup
# opts.test ends here
