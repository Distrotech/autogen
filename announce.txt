#!/bin/ksh
# -*- Mode: shell-script -*-
#
# $Id: announce.txt,v 4.9 2005/11/26 19:35:08 bkorb Exp $

test -z "${sender}" && sender=bkorb
domain=gnu.org
lname=${sender}@${domain}
fullname='Bruce Korb'
project=autogen

tfile=$(mktemp ./agaXXXXXX.txt) 2>/dev/null
test -z "${tfile}" && tfile=aga$$.txt

eval $(egrep '^A[GO]_[A-Z0-9_]*=' VERSION)
AO_VERSION=AutoOpts\ Version\ ${AO_CURRENT}.${AO_REVISION}

exec 3> ${tfile}

recip=$(echo ${lname} autogen-announce@lists.sf.net)

nl='
'

# Three levels of release:
# x.y        -- a primary release
# x.y.z      -- a bug fix release
# x.y.zpreX  -- an unofficial testing release
#
case ${AG_VERSION} in
*.*pre* )
  to_line='To: autogen-announce@lists.sf.net'
  cc_line=""
  alpha_rel=$(echo "\
This is a *pre* release of ${project}.

It is temporarily stored at the following 'primary ftp' site,
pending further testing.")

  recip=autogen-announce@lists.sf.net
  ftpurl=http://autogen.sf.net/data
  ;;

* )
  alpha_rel=""
  to_line='To: GNU Announcements <info-gnu@gnu.org>'
  cc_line="Cc: autogen-announce@lists.sf.net${nl}"
  recip=$(echo ${recip} info-gnu@gnu.org)
  ftpurl=ftp://ftp.gnu.org/gnu/${project}/rel-${AG_VERSION}
  ;;
esac

cat >&3 <<- _EOF_
	From: ${fullname} <${sender}@${domain}>
	Sender: ${sender}@${domain}
	${to_line}	
	Subject: GNU AutoGen Version ${AG_VERSION}/${AO_VERSION}
	Reply-To: autogen-users@lists.sf.net
	${cc_line}
	GNU AutoGen/AutoOpts is a two-part project that serves two separate
	purposes and are inextricably intertwined:

	AutoGen is a tool designed to simplify the creation and maintenance of
	programs that contain large amounts of repetitious text.  It is
	especially valuable in programs that have several blocks of text that
	must be kept synchronized.

	AutoOpts is both an example of that and a project in its own right.
	It is a very powerful command line option parser consisting of a set
	of AutoGen templates and a run time library that nearly eliminates
	the hassle of managing, parsing and documenting program options.

	New in ${AG_VERSION} - $(date '+%B, %Y')
	_EOF_

test ${#alpha_rel} -gt 1 && print -u3 "${alpha_rel}\n\n"

( echo
  case ${AG_VERSION} in
  *pre* )
    printf "Here are the change log entries since the last release"
    sed '/= [0-9.]* Released/,$d' ChangeLog | \
    sed '$d' | sed '$d' | sed '$d'
    ;;
  esac
) >&3

(
  echo "Here are the 'NEWS' entries since the last release"
  cat NEWS | \
  sed "1,/^New in ${AG_VERSION} -/d ; /^New in /,\$d"
) >&3

cat >&3 <<_EOF_

AutoGen home:    http://www.gnu.org/software/${project}/
primary ftp:     ${ftpurl}/
.tar.gz:         ${ftpurl}/${project}-${AG_VERSION}.tar.gz
library project: $(echo ${ftpurl} | \
  sed "s,${project}/.*,libopts/rel${AO_CURRENT}.${AO_REVISION}/,")
bug reports:     autogen-users at the SourceForge net domain
bug archive:     http://sourceforge.net/mailarchive/forum.php?forum_id=7034
maintainer:      Bruce Korb - bkorb at the usual GNU domain
_EOF_

exec 3>&-
recip=bruce.korb@gmail.com

echo "sendmail ${recip} < ${tfile}"

echo rm -f ${tfile}
