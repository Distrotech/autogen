#! /bin/sh
#  -*- Mode: Shell-script -*-
# ----------------------------------------------------------------------
# keyword.test ---  keyword option processing
#
# Time-stamp:        "2003-07-07 19:28:34 bkorb"
# Author:            Bruce Korb <bkorb@gnu.org>
# Maintainer:        Bruce Korb <bkorb@gnu.org>
# Created:           Fri Oct 1 10:27:31 PDT 1999
#
# $Id: keyword.test,v 3.6 2003/07/08 02:30:45 bkorb Exp $
# ----------------------------------------------------------------------

# Common definitions
if test -z "$srcdir"; then
    srcdir=`echo "$0" | sed 's,[^/]*$,,'`
    test -z "$srcdir" && srcdir=.
    test "$srcdir" = "$0" && srcdir=.
    test "${VERBOSE+set}" != set && VERBOSE=1
fi
. $srcdir/defs
set -x

# # # # # # # # # # DEFINITIONS FILE # # # # # # # # #

echo "creating ${testname}.def in `pwd`"
testname="${testname}" test_main="" \
argument="${argument}" long_opts="yes" \
${SHELL-sh} ${stdopts} option:'opt init'
cat >> ${testname}.def <<- _EndOfDef_
	help_value = X;
	homerc     = '.';
	rcfile     = ${testname}.cfg;
	test-main  = yes;

	flag = {
	    name        = trace;
	    arg-type    = keyword;
	    arg-default = nothing;
	    arg-name    = level;
	    descrip     = "tracing level of detail";
	    keyword     = nothing, templates, block-macros, expressions,
                      explanations;
	};

	flag = {
	    name        = sets;
	    arg-type    = set-members;
	    arg-default = second, fourth;
	    arg-name    = member-list;
	    descrip     = "set membership testing";
	    keyword     = first, second, third, fourth, fifth, sixth, seventh,
                      eighth, ninth, tenth;
	};
	_EndOfDef_

echo $AGEN ${testname}.def
$AGEN ${testname}.def || \
  failure AutoGen could not process

compile "-X"


# # # # # # # # # # HELP OUTPUT FILE # # # # # # # # #

echo creating ${testname}.hlp
cat > ${testname}.hlp <<'_EOF_'
test_keyword - Test AutoOpts for keyword
USAGE:  keyword [ -<flag> [<val>] | --<name>[{=| }<val>] ]...
  Flg Arg Option-Name    Description
   -o Str option         The option option descrip
      KWd trace          tracing level of detail
      Mbr sets           set membership testing
				- is a set membership option
   -X no  help           Display usage information and exit
   -! no  more-help      Extended usage information passed thru pager
   -> opt save-opts      Save the option state to an rc file
   -< Str load-opts      Load options from an rc file
				- disabled as --no-load-opts
				- may appear multiple times

Options are specified by doubled hyphens and their name
or by a single hyphen and the flag character.

The following option preset mechanisms are supported:
 - reading file ./keyword.cfg

The valid "trace" option keywords are:
	nothing
	templates
	block-macros
	expressions
	explanations
The valid "sets" option keywords are:
	first
	second
	third
	fourth
	fifth
	sixth
	seventh
	eighth
	ninth
	tenth
_EOF_

cmp -s ${testname}.h*lp || \
  failure "`diff ${testname}.h*lp`"

./${testname} --trace=exp > /dev/null 2>&1 && \
  failure ${testname} accepted ambiguous keyword

./${testname} --trace=expr --set=0 > ${testname}.t1-s || \
  failure ${testname} did not handle its options

./${testname} --trace=expr --save=${testname}.cfg || \
  failure ${testname} could not save its options

egrep -v '^#' ${testname}.cfg > ${testname}res.cfg || \
  failure ${testname} could not create ${testname}.cfg

cat > ${testname}base.cfg <<- _EndIni_
	trace               expressions
	_EndIni_

cmp -s ${testname}base.cfg ${testname}res.cfg || \
  failure "`diff ${testname}base.cfg ${testname}res.cfg`"

cat > ${testname}.t1-b <<- _EndTst_
	OPTION_CT=2
	export OPTION_CT
	TEST_KEYWORD_TRACE='expressions'
	export TEST_KEYWORD_TRACE
	TEST_KEYWORD_SETS=10
	export TEST_KEYWORD_SETS
	typeset -x -i SETS_FIRST=1 # 0x1
	typeset -x -i SETS_SECOND=2 # 0x2
	typeset -x -i SETS_THIRD=4 # 0x4
	typeset -x -i SETS_FOURTH=8 # 0x8
	typeset -x -i SETS_FIFTH=16 # 0x10
	typeset -x -i SETS_SIXTH=32 # 0x20
	typeset -x -i SETS_SEVENTH=64 # 0x40
	typeset -x -i SETS_EIGHTH=128 # 0x80
	typeset -x -i SETS_NINTH=256 # 0x100
	typeset -x -i SETS_TENTH=512 # 0x200
	_EndTst_

cmp -s ${testname}.t1-* || \
  failure "`diff ${testname}.t1-*`"

$AGEN -T agman1.tpl ${testname}.def
cat > ${testname}-base.1 <<_EOMan_
test_keyword \- Test AutoOpts for keyword
.SH SYNOPSIS
.B test_keyword
.\" Mixture of short (flag) options and long options
.RB [ -\fIflag\fP " [\fIvalue\fP]]... [" --\fIopt-name\fP " [[=| ]\fIvalue\fP]]..."
.PP
All arguments must be options.
.SH "DESCRIPTION"
This manual page documents, briefly, the \fBtest_keyword\fP command.
Its description is not documented.
.SH OPTIONS
.TP
.BR -o " \fIstring\fP, " --option "=" \fIstring\fP
The option option descrip.
The default \fIstring\fP for this option is:
.ti +4
opt init
.sp
This option has not beed fully documented.
.TP
.BR --trace "=\fIlevel\fP"
tracing level of detail.
This option takes a keyword as its argument.  The argument sets an enumeration value that can
be tested by comparing the option value macro.  The available keywords are:
.in +4
.nf
.na
nothing      templates    block-macros
expressions  explanations
.fi
.in -4
.sp
The default \fIlevel\fP for this option is:
.ti +4
nothing
.sp
This option has not beed fully documented.
.TP
.BR --sets "=\fImember-list\fP"
set membership testing.
This option takes a keyword as its argument list.  Each entry turns on or off
membership bits.  These bits can be tested with bit tests against the option value macro.  The available keywords are:
.in +4
.nf
.na
first   second  third   fourth  fifth   sixth
seventh eighth  ninth   tenth
.fi
.in -4
.sp
The default \fImember-list\fP for this option is:
.ti +4
second, fourth
.sp
This option has not beed fully documented.
.TP
.BR \-X , " \--help"
Display usage information and exit.
.TP
.BR \-! , " \--more-help"
Extended usage information passed thru pager.
.TP
.BR \-> " [\fIrcfile\fP]," " \--save-opts" "[=\fIrcfile\fP]"
Save the option state to \fIrcfile\fP.  The default is the \fIlast\fP
rc file listed in the \fBOPTION PRESETS\fP section, below.
.TP
.BR \-< " \fIrcfile\fP," " \--load-opts" "=\fIrcfile\fP," " --no-load-opts"
Load options from \fIrcfile\fP.
The \fIno-load-opts\fP form will disable the loading
of earlier RC/INI files.  \fI--no-load-opts\fP is handled early,
out of order.
.SH OPTION PRESETS
Any option that is not marked as \fInot presettable\fP may be preset
by loading values from RC (.ini) file(s).
The \fIhomerc\fP file is "\fI.\fP", unless that is a directory.
In that case, the file "\fIkeyword.cfg\fP"
is searched for within that directory.
.PP
This manual page was \fIAutoGen\fP-erated from the \fBtest_keyword\fP
option definitions.
_EOMan_

sed '1,/^\.SH NAME/d' ${testname}.1 > ${testname}-res.1
cmp -s ${testname}-base.1 ${testname}-res.1 || \
  failure "`diff ${testname}-base.1 ${testname}-res.1`"

cleanup
# end of keyword.test
