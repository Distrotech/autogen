#! /bin/sh
#  -*- Mode: Shell-script -*- 
# ----------------------------------------------------------------------
# bootstrap --- maintainer's bootstrap script
#
# Author:         Gary V. Vaughan <gvaughan@oranda.demon.co.uk>
# Maintainer:     Gary V. Vaughan <gvaughan@oranda.demon.co.uk>
# Created:        Thu Apr  9 00:40:23 1998
# Last Modified:     Mon Jun 21 11:14:25 1999				      
#            by:     Bruce Korb <korb@datadesign.com>			      
# ----------------------------------------------------------------------
# $Id: bootstrap,v 1.15 1999/07/07 16:04:20 bkorb Exp $
# ----------------------------------------------------------------------

# Code:

chmod +x snprintfv/config/genproto

# Figure out the absolute path to the working directory.
wd=`echo $0|sed 's,/[^/]*$,,'`
test -z "$wd" && wd=.
 
# Search for a configure.in
for srcdir in $wd $wd/.. .. .; do
    test -f $srcdir/configure.in && break
done

# ----------------------------------------------------------------------
# Make sure all of the maintainer tools required for bootstrap are
# available on the host machine.
# ----------------------------------------------------------------------
#
# Assume autoconf will be present until we can prove otherwise.
AUTOCONF=autoconf
AUTOHEADER=autoheader

# See whether the configure template requires automake.
ACLOCAL=aclocal
AUTOMAKE=:

sed 's,#.*$,,;s,dnl[ \t].*$,,' configure.in \
  | egrep 'A(C|M)_INIT_AUTOMAKE' > /dev/null && AUTOMAKE=automake

# See whether the configure template requires libtool.
LIBTOOLIZE=:
sed 's,#.*$,,;s,dnl[ \t].*$,,' configure.in \
  | egrep 'A(C|M)_PROG_LIBTOOL' > /dev/null && LIBTOOLIZE=libtoolize

 DIE=0
 
missing()
{
    cat >&2 <<-	_EOF_
	**ERROR**:  You must have \`$1\' installed to bootstrap autogen.
	Download the appropriate package for your distribution,
	or get the source at:
	    $2
	(or any later version found there)
	_EOF_
	DIE=1
}

doit ()
{
  if test "x$1" != x: ; then 
    echo "$@"
    eval "$@"
  fi
}

# We must be using autoconf (or we wouldn't need this script!).
$AUTOCONF --version >/dev/null 2>&1
if test $? -ne 0; then
  missing $AUTOCONF ftp://ftp.gnu.org/gnu/autoconf/autoconf-2.13.tar.gz

  # No point testing autoheader
  #
  AUTOHEADER=:
fi

# If autoconf failed we don't bother testing for autoheader.
$AUTOHEADER --version >/dev/null 2>&1
if test $? -ne 0; then
  missing $AUTOHEADER ftp://ftp.gnu.org/gnu/autoconf/autoconf-2.13.tar.gz
fi

# Check for the presence of libtool.
$LIBTOOLIZE --version >/dev/null 2>&1
if test $? -ne 0; then
  missing $LIBTOOLIZE ftp://ftp.gnu.org/gnu/libtool/libtool-1.3.tar.gz
fi

# Check for the presence of automake.
$AUTOMAKE --version >/dev/null 2>&1
if test $? -ne 0; then
  missing $AUTOMAKE ftp://ftp.gnu.org/gnu/automake/automake-1.4.tar.gz

  # No point testing aclocal
  #
  ACLOCAL=:
fi

# If automake failed we don't bother testing for aclocal.
$ACLOCAL --version >/dev/null 2>&1
if test $? -ne 0; then
  missing $ACLOCAL ftp://ftp.gnu.org/gnu/automake/automake-1.4.tar.gz
fi

# If any of the above tests failed, abort at this point.
test "$DIE" -ne 0 && exit $DIE

# ----------------------------------------------------------------------
# Since snprintfv has a mutual dependency on libopts from AutoGen-4.5.3
# and above, this link is necessary to bootstrap snprintfv's test
# directory.
# ----------------------------------------------------------------------
test -f ./autoopts/autoopts.m4 \
  && rm -f ./snprintfv/acinclude.m4 \
  && ln -s `pwd`/autoopts/autoopts.m4 ./snprintfv/acinclude.m4

# ----------------------------------------------------------------------
# automake wants this stuff now, but we generate it later!
# ----------------------------------------------------------------------
test -f doc/autogen.texi || echo '@setfilename fnord' > doc/autogen.texi

# Still here?  Run through all of the required autogeneration tools in
# each directory which contains a configure.in file...
for i in `find $srcdir -name configure.in -print|grep -v CVS/`
do
  # Find the top directory with respect to the current configure.in.
  top=`echo $i|sed 's,/[^/]*$,,'`
  case $i in
    /* | [A-Za-z]:\\*) ;;
    *) top=`(cd $top && pwd)` ;;
  esac

  # A brief check to make sure we are not running in the wrong
  # directory.
  initfile=`fgrep AC_INIT $top/configure.in | sed 's,^.*(,,;s,).*$,,'`
  if test -z "$initfile" || test ! -f $top/$initfile; then
    cat <<- 'EOF'
	**Error**: Directory \`$top\' does not look like a valid
	top-level directory.
	EOF
    exit 1
  fi

  # Execute this in a sub-shell so we don't lose our start location.
  (
    cd $top
    echo bootstrapping in `pwd`

    # remove any stale config.cache
    doit rm -f config.cache

    # Use auxdir if set in configure.in.
    auxdir=${auxdir-`fgrep CONFIG_AUX_DIR configure.in | \
        sed 's,^.*(,,;s,).*$,,'`}
    test -n "$auxdir" || auxdir=$srcdir
    test -d $auxdir || auxdir=.

    if sed 's,#.*$,,;s,dnl[ \t].*$,,' configure.in \
      | egrep 'A(C|M)_PROG_LIBTOOL' > /dev/null ; then
    doit $LIBTOOLIZE    --force
    fi
    
    if sed 's,#.*$,,;s,dnl[ \t].*$,,' configure.in \
      | egrep 'A(C|M)_INIT_AUTOMAKE' > /dev/null ; then
    doit $ACLOCAL       -I $auxdir
    fi

    doit $AUTOHEADER    -l $auxdir
        
    if sed 's,#.*$,,;s,dnl[ \t].*$,,' configure.in \
      | egrep 'A(C|M)_INIT_AUTOMAKE' > /dev/null ; then
    doit $AUTOMAKE      --gnu --add-missing
    fi

    doit $AUTOCONF      -l config/
  )
done

# remove the fake file so we don't forget to generate it later.
test "`sed 2q doc/autogen.texi`" != "@setfilename fnord" \
    || rm -f doc/autogen.texi

autogen --help > /dev/null 2>&1 || {
  echo AutoGen not available
  exit 0
}

getdefs --help > /dev/null 2>&1 || {
  echo getdefs not available
  exit 0
}

columns --help > /dev/null 2>&1 || {
  echo columns not available
  exit 0
}

which which > /dev/null 2>&1 || {
  echo Cannot determine program locations
  exit 0
}

(
  cd config
  echo Genning config/ctime.m4
  autogen ctime.def
) || exit 1

find . -name bootstrap |
egrep -v '(CVS/Base/|config/bootstrap)'   |
while read f
do
  (cd `dirname $f`
   echo running bootstrap in `pwd`
   sh bootstrap recursive )
done

OPTDIR=`pwd`/autoopts

find . -name 'opts.def' |
egrep -v 'CVS/Base/'    |
sed 's;\.def$;;'        |
while read f
do
  if [ ! -f ${f}.c ]
  then
    ( cd `dirname $f`
      echo bootstrapping options in `pwd`
      autogen -L $OPTDIR opts.def
    )
  fi
done

# bootstrap ends here
