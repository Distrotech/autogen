#! /bin/ksh
#  -*- Mode: Shell-script -*-
# ----------------------------------------------------------------------
timestamp=$(set -- \
  Time-stamp:        "2009-07-22 18:51:11 bkorb"
  echo ${2} | sed 's/:[0-9][0-9] .*//;s/[^0-9]//g')
##
## Author:            Bruce Korb <bkorb@gnu.org>
##            by: bkorb
##
##  This file is part of AutoGen.
##  AutoGen copyright (c) 1992-2009 by Bruce Korb - all rights reserved
##
## AutoGen is free software: you can redistribute it and/or modify it
## under the terms of the GNU General Public License as published by the
## Free Software Foundation, either version 3 of the License, or
## (at your option) any later version.
##
## AutoGen is distributed in the hope that it will be useful, but
## WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
## See the GNU General Public License for more details.
##
## You should have received a copy of the GNU General Public License along
## with this program.  If not, see <http://www.gnu.org/licenses/>.
# ----------------------------------------------------------------------
# @(#) $Id$
# ----------------------------------------------------------------------
case "$1" in
-CVS ) update_cvs=true  ;;
-*   ) echo "USAGE: $0 [-CVS]"
       echo "Create a new version of 'noag-boot.sh'."
       echo "'-CVS' specifies commiting the new file, too."
       echo "This program should be run in a checkout tree."
       exit 0
       ;;
*    ) update_cvs=false ;;
esac

die() {
  echo "mkconfig fatal error:  $*" >&2
  exit 1
}

program=${0}
prog=$(basename ${0})

sd=$(\cd $(dirname $0) > /dev/null 2>&1 && pwd -P)
test -n "${sd}" || die "Cannot locate source directory for $0"
test -d ${sd}/CVS || die "No CVS directory in ${sd}"

tmpag=$( (mktemp -d $HOME/tmp/ZZXXXXXX.d) 2>/dev/null)
test -z "${tmpag}" && tmpag=$HOME/tmp/ZZ$$.d && {
  mkdir -p ${tmpag} || die "Cannot make directory ${tmpag}"
}

cd ${tmpag} || die "cannot cd to ${tmpag}"
cfgfile=$(\cd .. >/dev/null && pwd -P)/config$$.tmp
exec 5> ${cfgfile}
cp -frp ${sd}/* .

find * -type f | xargs chmod u+w
find * -type d | xargs chmod 755

bstr=$(set -- c*f*g/bootstrap ; echo $1)
test -f ${bstr} || die "Cannot locate bootstrap file"
sh $bstr || die "error:  bootstrap failed"

nl=$'\n'
GENLIST=''
STAMPLIST=''
PROTOLIST=''

for f in $(find * -type f | fgrep -v CVS/ | sort)
do
  case "$f" in
  */stamp*    | \
  */*stamp    )
    test -f ${sd}/${f} || STAMPLIST="${STAMPLIST}${f}${nl}" ;;

  */proto.h   )
    test -f ${sd}/${f} || PROTOLIST="${PROTOLIST}${f}${nl}" ;;

  configure   | \
  config*.tmp | \
  *.in        | \
  *~          | \
  aclocal*    | \
  autom4*     ) : ;;
  * )
    test -f ${sd}/${f} || GENLIST="${GENLIST}${f}${nl}"
    ;;
  esac
done

#  Make sure the new file removes the current collection of files
#
cat <<- _EOF_ >&5
	#! /bin/sh
	#
	#  DO NOT EDIT THIS FILE
	#
	#  It is generated by ${prog}.  Make necessary changes there.
	#
	# ----------------------------------------------------------------------
	_EOF_

sed '1,/^##/d;/-----/q' $0 >&5
cat <<- '_EOF_' >&5
	SVDIR=`pwd`
	cd `echo $0 | sed 's;/[^/]*$;;'`
	SRCDIR=`pwd`

	if [ ! -f ./configure.ac ]
	then
	  echo cannot locate top source directory for AutoGen
	  exit 1
	fi

	if [ -z "${VERBOSE}" ]
	then VERBOSE=false ; VERBOSE_ARG=""
	else VERBOSE=true ; VERBOSE_ARG="-x" ; set -x ; fi
	export VERBOSE VERBOSE_ARG

	#  Touch the stamp-* files so bootstrap.dir won't try to build them
	#
	_EOF_

echo "touch -t ${timestamp} \\" >&5

for f in ${STAMPLIST}
do echo $f
done | columns --spread=1 -I8 --line=" \\" >&5

echo >&5

for f in ${GENLIST}
do echo $f ; done | \
columns --spread=1 -I10 --first='for f in ' --line=" \\" >&5

cat <<- '_EOF_' >&5
	do
	  d=`dirname $f`
	  test -d $d || {
	    mkdir -p $d
	    continue
	  }
	  test -f $f && rm -f $f
	done
	_EOF_

start_mark='DO NOT EDIT THIS FILE'
end_mark='\(and the template file\|It has been extracted by getdefs\)'

# Strip out variable parts of generated files.
#
for f in ${GENLIST}
do
  sed -i "/${start_mark}/,/${end_mark}/d" ${f} || continue
done

for f in ${PROTOLIST}
do
  sed -i '/^ \* Generated/d' ${f}
done

touch -t ${timestamp} ${GENLIST}

readonly preamble=\
'(uudecode -o /dev/stdout | gunzip -c) > %s <''< \_EOArchive_\n'

for f in ${GENLIST}
do
    printf "${preamble}" $f
    gzip --best -c $f | uuencode -m /dev/stdout
    echo _EOArchive_
    echo
done >&5

#  Finally, add the code that generates the files generated
#  by standard tools (yacc/byacc/bison).
#
cat <<- '_EOF_' >&5

	sh ${VERBOSE_ARG} config/bootstrap $@ || exit 1
	cd $SVDIR
	sh ${VERBOSE_ARG} ${SRCDIR}/configure $@
	exit 0
	# noag-boot.sh ends here
	_EOF_

exec 5>&-

if cmp ${cfgfile} ${sd}/noag-boot.sh
then
  echo noag-boot.sh is unchanged
  rm -f ${cfgfile}

elif ${update_cvs:-false}
then
  cd $sd
  cvs edit noag-boot.sh
  mv -f ${cfgfile} noag-boot.sh
  cvs commit -m'CVS-ed noag-boot.sh script update' noag-boot.sh

elif test -t 1
then
  ( cd $sd
    echo noag-boot.sh would change:
    echo diff -c noag-boot.sh ${cfgfile}
    diff -c noag-boot.sh ${cfgfile}
  ) | ${PAGER-more}
fi

rm -rf ${tmpag}

# mkconfig.sh ends here
