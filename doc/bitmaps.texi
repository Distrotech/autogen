@node Bit Maps
@section Bit Maps and Enumerations

AutoGen provides two templates for managing enumerations and bit maps
(flag words).  They produce an enumeration of the enum or @code{#define}s
for the bit maps, plus conversion functions for converting a string into
one of these values or converting one of these values into a human readable
string.  There is a separate project that produces a GDB add-on that
will add these capabilities into GDB for bit masks.  (GDB does just fine
with enumerations.)

@menu
* enums::           Enumerations
* enum-code::       Strings to Enums and Back
* masks::           Bit Maps and Masks
@end menu

@node enums
@subsection Enumerations

@file{str2enum.tpl}

Produce an enumeration for a list of input ``cmd''s (names).
Optionally, produce functions to:

@itemize @bullet
@item
convert a string to an enumeration
@item
convert an enumeration value into a string
@item
invoke a function based on the first token name found in a string
@end itemize
 
The header file produced will contain the enumeration and declarations
for the optional procedures.  The code (@file{.c}) file will contain
these optional procedures, but can be omitted if the @code{no-code}
attribute is specified.

The following attributes are recognized with the @code{str2enum} template:

@table @samp
@item cmd
You must provide a series of these attributes: they specify the list of
names used in the enumeration.  Specific values for the names may be
specified by specifying a numeric index for these attributes.
e.g. @code{cmd[5] = mumble;} will cause
@example
FOO_CMD_MUMBLE = 5
@end example
@noindent
to be inserted into the enumeration.

@item prefix
This specifies the first segment of each enumeration name.
If not specified, the first segment of the enumeration definition file name
will be used.  e.g. @file{foo-bar.def} will default to a @code{FOO} prefix.

@item type
Normally, there is a second constant segment following the prefix.  If not
specified, it will be @code{CMD}, so if both @code{prefix} and @code{type}
were to default from @file{foo-bar.def}, you will have enumeration values
prefixed with @code{FOO_CMD_}.  If specified as the empty string, there will
be no ``type'' component to the name and the default constant prefix will
thus be @code{FOO_}.

@item base-name
This specifies the base name of the output files, enumeration type and the
translation functions.  The default is to use the @code{basename(3)} of
the definition file.  e.g. @file{foo-bar.def} results in a @code{base-name}
of @code{foo-bar}.

@item invalid-val
The default invalid value is zero.  Sometimes, it is useful for zero to be
valid.  If so, you can specify @t{~0} or the empty string to be invalid.
The empty string will cause the enumeration count (maximum value plus 1) to
be the invalid value.

@item invalid-name
By default, the invalid value is emitted into the enumeration as
@code{FOO_INVALID_CMD}.  Specifying this attribute will replace
@code{INVALID} with whatever you place in this attribute.

@item add-on-text
Additional text to insert into the code or header file.

@table @samp
@item ao-file
Which file to insert the text into.  There are four choices,
only two of which are relevant for the @file{str2enum} template:
``@t{enum-header}'', ``@t{enum-code}'', ``@t{mask-header}'' or ``@t{mask-code}''.

@item ao-text
The text to insert.
@end table
@end table

@c
@c * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
@c
@node enum-code
@subsection Strings to Enums and Back

A continuation of the attributes for the @file{str2enum.tpl} template.

@table @samp
@item no-code
Do not emit any string to enumeration or enumeration to string code at all.
If this is specified, the remainder of the attributes have no effect.

@item no-name
Do not emit the enumeration to name function.

@item no-case
When looking up a string, the case of the input string is ignored.

@item alias
A single punctuation character can be interpreted as a command.  The first
character of this attribute is the aliased character and the remainder the
aliased-to command.  e.g. ``@t{#comment}'' makes '@t{#}' an alias for the
@command{comment} command.

@item length
Specify how lengths are to be handled.  Under the covers, @command{gperf(1)}
is used to map a string to an enumeration value.  The code it produces
requires the string length to be passed in.  You may pass in the length
yourself, or the generated code may figure it out, or you may ask for that
length to be returned back after being figured out.

You have four choices with the @code{length} attribute:

@itemize @bullet
@item
Do not specify it.  You will need to provide the length.
@item
Specify ``@t{provided}''.  You will need to provide the length.
@item
Specify ``@t{returned}''.  You must pass a pointer to a @t{size_t} object.
If the name is found, the length will be put there.
@item
Specify an empty string.  The generated code will compute the length and
that computed length will not be returned.  The length parameter may be
omitted.  If the input strings contain only enumeration names, then this
would be sufficient.
@item
Specifying anything else is undefined.
@end itemize

@item partial
Normally, a name must fully match to be found successfully.  This attribute
causes the generated code to look for partial matches if the full match
@command{gperf} function fails.  Partial matches must be at least two
characters long.

@item undef-str
by default, the display string for an undefined value is
``@t{* UNDEFINED *}''.  Use this to change that.

@item equate
A series of punctuation characters considered equivalent.
Typically, ``@t{-_}'' but sometimes (Tandem) ``@t{-_^}''.  Do not use '@t{#}'

@item dispatch
The lookup procedure will call a dispatch function.
You must provide a function for every named ``cmd'',
though you can use @code{add-on-text} to ``@t{#define}'' one
function to another.  The first two dispatch attributes are required,
and the @code{d-arg} attribute is optional:

@table @samp
@item d-nam
This must be a printf format string with one formatting element: @code{%s}.
The @code{%s} will be replaced by each @code{cmd} name, including
``@t{invalid}'' (or the value of @code{invalid-val}, if specified).

@item d-ret
The return type of the dispatched function, even if ``@t{void}''.

@item d-arg
If there are additional arguments that are to be passed through to the
dispatched function, specify this as though it were part of the procedure
header.  (It will be glued into the dispatching function as is and sedded
into what is needed for the dispatched function.)
@end table

The handler functions will have the command enumeration as its first first
argument, a pointer to a constant string that will be the character
@i{after} the parsed command (keyword) name, plus any @code{d-arg} arguments
that follow that.
@end table

@c
@c * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
@c
@node masks
@subsection Bit Maps and Masks

@file{str2mask.tpl}

This template leverages highly off of enumerations (@pxref{enums}).  It will
produce a header file with bit masks defined for each bit specified with a
@code{cmd} attribute.  63 is the highest legal bit number because this
template has not been extended to cope with multiple word masks.  (Patches
would be welcome.)

There are a few constraints on the names allowed:

@itemize @bullet
@item
names are constrained to alphanumerics and the underscore
@item
aliases are not allowed
@item
dispatch procedures are not allowed
@end itemize

@code{no-code} and @code{no-name} are honored.  @code{dispatch} is not.  The
lookup function will examine each token in an input string, determine which
bit is specified and add it into a result.  The names may be prefixed with a
hyphen (@t{-}) or tilde (@t{~}) to remove the bit(s) from the cumulative
result.  If the string begins with a plus (@t{+}), hyphen or tilde, a ``base
value'' parameter is used for the starting mask, otherwise the conversion
starts with zero.

Beyond the enumeration attributes that are used (or ignored), the
@file{str2mask} template accepts a @code{mask} attribute.  It takes a few
``subattributes'':

@table @samp
@item m-name
a special name for a sub-collection of the mask bits

@item m-bit
The name of each previously defined bit(s).  If the desired previously
defined value is a mask, that @code{m-name} must be suffixed with ``@t{-mask}''.

@item m-invert
When all done collecting the bits, x-or the value with the mask
of all the bits in the collection.
@end table

@noindent
A mask of all bits in the collection is always generated.
